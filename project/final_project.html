<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Seismic Activity Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { height: 100%; margin: 0; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .legend {
            line-height: 18px;
            color: #333;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
            border-radius: 50%;
        }
    </style>
</head>
<body class="font-sans bg-gray-100 h-screen flex overflow-hidden">

    <!-- Sidebar / Control Panel -->
    <div class="w-full md:w-96 bg-white shadow-2xl z-20 flex flex-col h-full absolute md:relative transform transition-transform duration-300 ease-in-out" id="sidebar">
        
        <!-- Header -->
        <div class="p-6 bg-slate-800 text-white">
            <h1 class="text-2xl font-bold mb-1"><i class="fa-solid fa-earth-americas mr-2"></i>US Earthquake Map</h1>
            <p class="text-slate-400 text-sm">Real-time USGS Data (Past 7 Days)</p>
        </div>

        <!-- Controls -->
        <div class="p-6 border-b border-gray-200 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Minimum Magnitude</label>
                <input type="range" id="magFilter" min="0" max="8" step="0.5" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0</span>
                    <span id="magValue" class="font-bold text-blue-600 text-base">1.0+</span>
                    <span>8.0</span>
                </div>
            </div>
            
            <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg">
                <div class="text-sm text-blue-800">
                    <span class="font-bold" id="eventCount">Loading...</span> Earthquakes visible
                </div>
                <button onclick="resetView()" class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded transition">
                    Reset View
                </button>
            </div>
        </div>

        <!-- Recent Events List -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" id="eventsList">
            <!-- List items will be injected here via JS -->
            <div class="text-center text-gray-500 mt-10">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Fetching data from USGS...</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 bg-gray-100 border-t border-gray-200 text-xs text-gray-500 text-center">
            Project by Josiah Williams & Monica Layug
        </div>
    </div>

    <!-- Map Container -->
    <div class="flex-1 relative">
        <!-- Mobile Toggle Button -->
        <button id="sidebarToggle" class="absolute top-4 left-4 z-[1000] md:hidden bg-white p-2 rounded-md shadow-lg text-slate-800">
            <i class="fa-solid fa-bars"></i>
        </button>
        
        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Configuration ---
        const USGS_URL = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson";
        
        // --- Map Initialization ---
        // Centered on US
        const map = L.map('map').setView([39.8283, -98.5795], 4);

        // Add OpenStreetMap Tile Layer (Light/Gray version looks better for data viz)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // --- Helper Functions for Styling ---

        // Color based on Depth (km)
        // Shallow (<10km) = Green/Yellow, Deep (>70km) = Red/Purple
        function getColor(depth) {
            return depth > 90 ? '#800026' :
                   depth > 70 ? '#BD0026' :
                   depth > 50 ? '#E31A1C' :
                   depth > 30 ? '#FC4E2A' :
                   depth > 10 ? '#FD8D3C' :
                                '#FEB24C';
        }

        // Radius based on Magnitude
        function getRadius(magnitude) {
            return magnitude === 0 ? 1 : magnitude * 4;
        }

        // --- Data Handling ---
        let allFeatures = [];
        let geoJsonLayer;

        async function fetchData() {
            try {
                const response = await fetch(USGS_URL);
                const data = await response.json();
                allFeatures = data.features;
                
                renderMap(allFeatures);
                updateList(allFeatures);
                updateCount(allFeatures.length);
                
            } catch (error) {
                console.error("Error fetching USGS data:", error);
                document.getElementById('eventsList').innerHTML = `<div class="text-red-500 text-center p-4">Failed to load data. check internet connection.</div>`;
            }
        }

        function renderMap(features) {
            // Clear existing layer if it exists
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
            }

            geoJsonLayer = L.geoJSON(features, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: getRadius(feature.properties.mag),
                        fillColor: getColor(feature.geometry.coordinates[2]), // Depth is the 3rd coordinate
                        color: "#000",
                        weight: 0.5,
                        opacity: 1,
                        fillOpacity: 0.7
                    });
                },
                onEachFeature: function (feature, layer) {
                    // Add Popup
                    const date = new Date(feature.properties.time).toLocaleString();
                    layer.bindPopup(`
                        <div class="font-sans">
                            <h3 class="font-bold text-lg mb-1">Mag ${feature.properties.mag}</h3>
                            <p class="text-sm text-gray-600 mb-2">${feature.properties.place}</p>
                            <div class="text-xs bg-gray-100 p-2 rounded">
                                <p><strong>Depth:</strong> ${feature.geometry.coordinates[2]} km</p>
                                <p><strong>Time:</strong> ${date}</p>
                            </div>
                            <a href="${feature.properties.url}" target="_blank" class="block mt-2 text-blue-600 text-xs hover:underline">View on USGS &rarr;</a>
                        </div>
                    `);
                }
            }).addTo(map);
        }

        // --- Sidebar & UI Logic ---

        function updateList(features) {
            const listContainer = document.getElementById('eventsList');
            listContainer.innerHTML = '';

            // Sort by magnitude (descending) and take top 50 to avoid lagging DOM
            const sorted = [...features].sort((a, b) => b.properties.mag - a.properties.mag).slice(0, 50);

            if (sorted.length === 0) {
                listContainer.innerHTML = '<div class="p-4 text-center text-gray-500">No earthquakes found matching criteria.</div>';
                return;
            }

            sorted.forEach(feature => {
                const item = document.createElement('div');
                item.className = "bg-white p-3 rounded shadow-sm border-l-4 hover:bg-gray-50 cursor-pointer transition";
                // Color the border based on depth to match map
                item.style.borderLeftColor = getColor(feature.geometry.coordinates[2]); 
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-gray-800">Mag ${feature.properties.mag.toFixed(1)}</h4>
                            <p class="text-xs text-gray-500 truncate w-48">${feature.properties.place}</p>
                        </div>
                        <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">${feature.geometry.coordinates[2]}km</span>
                    </div>
                `;

                // Click list item to zoom to map
                item.addEventListener('click', () => {
                    const coords = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                    map.flyTo(coords, 10);
                    // Ideally we would open the popup here too, but needs layer ref lookup
                });

                listContainer.appendChild(item);
            });
        }

        function updateCount(count) {
            document.getElementById('eventCount').textContent = count;
        }

        // --- Filter Logic ---
        const magInput = document.getElementById('magFilter');
        const magValue = document.getElementById('magValue');

        magInput.addEventListener('input', (e) => {
            const minMag = parseFloat(e.target.value);
            magValue.textContent = minMag.toFixed(1) + "+";
            
            // Filter features
            const filtered = allFeatures.filter(f => f.properties.mag >= minMag);
            
            renderMap(filtered);
            updateList(filtered);
            updateCount(filtered.length);
        });

        function resetView() {
            map.setView([39.8283, -98.5795], 4);
            magInput.value = 1;
            magInput.dispatchEvent(new Event('input')); // Trigger filter reset
        }

        // --- Legend Control ---
        const legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            const grades = [0, 10, 30, 50, 70, 90];
            const labels = ['<strong>Depth (km)</strong>'];

            for (let i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            
            // Add Magnitude explanation
            div.innerHTML += '<hr class="my-2 border-gray-200">';
            div.innerHTML += '<div class="text-xs"><span class="inline-block w-3 h-3 bg-gray-400 rounded-full mr-1"></span> Size = Magnitude</div>';
            
            return div;
        };

        legend.addTo(map);

        // Mobile Sidebar Toggle
        const toggleBtn = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('absolute'); // Switch between absolute and flow
        });

        // Initialize
        fetchData();

    </script>
</body>
</html>
